// Once, javascript is written in a modular format, all initialization
// code should be called from here.
Hyrax = {
    initialize: function () {
        this.popovers();
        this.permissions();
        this.notifications();
        this.transfers();
        this.workEditor();
        this.fileManager();
        this.selectWorkType();
        this.selectCollectionType();
        this.datatable();
        this.adminSetEditor();
        this.collectionEditor();
        this.collectionsV2();
        this.collectionTypes();
        this.collectionTypeEditor();
        this.collectionUtilities();
        this.adminStatisticsGraphs();
        this.sortAndPerPage();
        this.sidebar();
        this.batchSelect();
        this.internationalizationHelper();
    },

    // The AdminSet edit page
    adminSetEditor: function() {
      var AdminSetControls = require('hyrax/admin/admin_set_controls');
      var controls = new AdminSetControls($('#admin-set-controls'));
    },

    // The collectionType edit page
    collectionTypeEditor: function() {
      var CollectionTypeControls = require('hyrax/admin/collection_type_controls');
      var controls = new CollectionTypeControls($('#collection-types-controls'));
    },

    // The Collection edit page
    collectionEditor: function() {
      var CollectionControls = require('hyrax/collections/editor');
      var controls = new CollectionControls($('#collection-edit-controls'));
    },

    // Collections v2 - collections related js should (over time) be moved here
    // from 'collections.js' to take advantage of shared modules
    collectionsV2: function() {
      var CollectionsV2 = require('hyrax/collections_v2');
      new CollectionsV2();
    },

    // Collection types
    collectionTypes: function() {
      var CollectionTypes = require('hyrax/collection_types');
      var collection_types = new CollectionTypes($('.collection-types-wrapper'))
    },

    collectionUtilities: function() {
      var CollectionUtilities = require('hyrax/collections_utils');
      new CollectionUtilities();
    },

    // Pretty graphs on the dashboard page
    adminStatisticsGraphs: function() {
        var AdminGraphs = require('hyrax/admin/graphs');
        new AdminGraphs(Hyrax.statistics);
    },

    // Sortable/pageable tables
    datatable: function () {
        // This keeps the datatable from being added to a table that already has it.
        // This is a problem when turbolinks is active.
        if ($('.dataTables_wrapper').length === 0) {
            $('.datatable').DataTable();
        }
    },

    internationalizationHelper: function () {
        var InternationalizationHelper = require('hyrax/i18n_helper');
        new InternationalizationHelper();
    },

    // The work edit page
    workEditor: function () {
        var element = $("[data-behavior='work-form']")
        if (element.length > 0) {
          var Editor = require('hyrax/editor');
          new Editor(element).init();
        }
    },

    // Popover help modals. Used on the user profile page.
    popovers: function () {
        $("a[data-toggle=popover]").popover({html: true})
            .on("click", function () {
                return false;
            });
    },

    // Add access grants for a user/group to a work/fileset/collection
    // TODO: This could get moved to workEditor() or similar
    permissions: function () {
        var PermissionsControl = require('hyrax/permissions/control');
        // On the edit work page
        new PermissionsControl($("#share"), 'tmpl-work-grant');
        // On the edit fileset page
        new PermissionsControl($("#permission"), 'tmpl-file-set-grant', { with_visibility_component: true });
        // On the batch edit page
        new PermissionsControl($("#form_permissions"), 'tmpl-work-grant');
        // On the edit collection page
        new PermissionsControl($("#collection_permissions"), 'tmpl-collection-grant');
    },

    // ActionCable for user notifications. This is displayed in the navbar.
    notifications: function() {
        // Do not create a consumer if user is not logged in
        if ($("meta[name='current-user']").length === 0)
            return;
        <% if Hyrax.config.realtime_notifications? %>
        var consumer = ActionCable.createConsumer("<%= Hyrax::Engine.routes.url_helpers.notifications_endpoint_path %>");
        consumer.subscriptions.create("Hyrax::NotificationsChannel", {
            connected: function(data) {
                this.perform("update_locale", { locale: $('html').attr('lang') });
            },

            received: function(data) {
                var Notification = require('hyrax/notification');
                new Notification($('.notify-number')).update(data.notifications_count, data.notifications_label);
            }
        });
        <% end %>
    },

    // Search for a user to transfer a work to
    transfers: function () {
        $("#proxy_deposit_request_transfer_to").userSearch();
    },

    // Popover menu to select the type of work when starting a deposit
    selectWorkType: function () {
        var SelectWorkType = require('hyrax/select_work_type');
        $("[data-behavior=select-work]").each(function () {
            new SelectWorkType($(this));
        });
    },

    // Popover menu to select the type when creating a new collection
    selectCollectionType: function () {
        var SelectCollectionType = require('hyrax/select_collection_type');
        $("[data-behavior=select-collection]").each(function () {
            new SelectCollectionType($(this)); // eslint-disable-line no-new
        });
    },

    // Minimize/maximize the dashboard sidebar
    sidebar: function () {
        var updateSidebarState = function() {
            var isMobile = $(window).width() < 992;
            var $sidebar = $('.sidebar');
            var $toggle = $('.sidebar-toggle');
            var isMaximized = $sidebar.hasClass('maximized');
            
            if (isMobile) {
                // On mobile, ensure sidebar is collapsed
                $('.sidebar, .main-content').removeClass('maximized');
                $toggle.attr('aria-expanded', 'false');
            } else {
                // On desktop, ensure sidebar is maximized
                $('.sidebar, .main-content').addClass('maximized');
                $toggle.attr('aria-expanded', 'true');
            }
        };

        // Prevent keyboard focus from reaching greyed-out content
        var manageFocusTrap = function() {
            var isMobile = $(window).width() < 992;
            var $mainContent = $('.main-content');
            var isMaximized = $mainContent.hasClass('maximized');
            
            if (isMobile && isMaximized) {
                // Set tabindex on all focusable elements in greyed-out content
                $mainContent.find('a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])').each(function() {
                    if (!$(this).attr('data-original-tabindex')) {
                        $(this).attr('data-original-tabindex', $(this).attr('tabindex') || '0');
                        $(this).attr('tabindex', '-1');
                    }
                });
            } else {
                $mainContent.find('[data-original-tabindex]').each(function() {
                    var originalTabindex = $(this).attr('data-original-tabindex');
                    $(this).attr('tabindex', originalTabindex === '0' ? null : originalTabindex);
                    $(this).removeAttr('data-original-tabindex');
                });
            }
        };

        var toggleSidebar = function() {
            var $sidebar = $('.sidebar');
            var $toggle = $('.sidebar-toggle');
            var $mainContent = $('.main-content');
            var isMobile = $(window).width() < 992;
            var isMaximized = $sidebar.hasClass('maximized');
            
            $('.sidebar, .main-content').toggleClass('maximized');
            $toggle.attr('aria-expanded', !isMaximized);
            
            // Manage sidebar state changes
            manageFocusTrap();
            
            // Focus management for accessibility
            if (isMobile) {
                if (!isMaximized) {
                    // Sidebar focus to first element in sidebar
                    var $firstFocusable = $sidebar.find('a, button, [tabindex]:not([tabindex="-1"])').first();
                    if ($firstFocusable.length) {
                        setTimeout(function() {
                            $firstFocusable.focus();
                        }, 100);
                    }
                } else {
                    // Return focus to toggle button
                    $toggle.focus();
                }
            }
        };

        // Set initial state
        updateSidebarState();
        manageFocusTrap();
        
        // Add initialized class to prevent the flash of open sidebar on mobile page load
        $('.sidebar, .main-content').addClass('js-initialized');

        // Update state when window is resized
        $(window).on('resize', function() {
            updateSidebarState();
            manageFocusTrap();
        });

        // Toggle sidebar on click
        $('.sidebar-toggle').on('click', function() {
            toggleSidebar();
        });

        // Toggle sidebar on keyboard press
        $('.sidebar-toggle').on('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                toggleSidebar();
            }
        });

        // Close sidebar when clicking backdrop on mobile
        $('.sidebar-backdrop').on('click', function() {
            if ($(window).width() < 992) {
                $('.sidebar, .main-content').removeClass('maximized');
                $('.sidebar-toggle').attr('aria-expanded', 'false');
                manageFocusTrap();
                $('.sidebar-toggle').focus();
            }
        });

        // Close sidebar on Escape key when open on mobile
        $(document).on('keydown', function(e) {
            if (e.key === 'Escape' && $(window).width() < 992) {
                var $sidebar = $('.sidebar');
                if ($sidebar.hasClass('maximized')) {
                    $('.sidebar, .main-content').removeClass('maximized');
                    $('.sidebar-toggle').attr('aria-expanded', 'false');
                    manageFocusTrap();
                    $('.sidebar-toggle').focus();
                }
            }
        });
    },

    // Add and reorder files attached to works
    fileManager: function () {
        var FileManager = require('hyrax/file_manager');
        new FileManager();
    },

    // Per Page select will submit its form to change records shown
    sortAndPerPage: function () {
        var SortAndPerPage = require('hyrax/sort_and_per_page');
        $('#sort, #per_page').each(function () {
            new SortAndPerPage($(this));
        });
    },

    // Saved so that inline javascript can put data somewhere.
    statistics: {},

    // initialized in hyrax/config.js
    config: {},

    // Adds selected items to the batch before any batch operation is performed
    batchSelect: function () {
        var BatchSelect = require('hyrax/batch_select');
        BatchSelect.initialize_batch_selected();
    }
};
